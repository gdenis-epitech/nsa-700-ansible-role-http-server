---
- name: "Load app variables"
  ansible.builtin.include_vars: app.vars.ansible.yaml

- name: "Copy app to server"
  become: true
  ansible.builtin.copy:
    src: files/app/
    dest: /var/www/app/
    directory_mode:
    owner: www-data
    group: www-data
    mode: "0777"

- name: "Update application .env"
  become: true
  ansible.builtin.template:
    src: files/laravel.env.j2
    dest: /var/www/app/.env
    owner: www-data
    group: www-data
    mode: "0777"

- name: "Update composer dependencies"
  become: false
  become_user: www-data
  community.general.composer:
    command: update
    working_dir: /var/www/app
  environment:
    COMPOSER_NO_INTERACTION: "1"
    COMPOSER_ALLOW_SUPERUSER: "1"

- name: "Generate app encryption key"
  become: false
  become_user: www-data
  ansible.builtin.command:
    chdir: /var/www/app
    cmd: "php artisan key:generate"
  register: out
  changed_when: out.rc != 0

- name: "Clear artisan config"
  become: false
  become_user: www-data
  ansible.builtin.command:
    chdir: /var/www/app
    cmd: "php artisan config:clear"
  changed_when: out.rc != 0

- name: "Cache artisan config"
  become: false
  become_user: www-data
  ansible.builtin.command:
    chdir: /var/www/app
    cmd: "php artisan config:cache"
  register: out
  changed_when: out.rc != 0

- name: "Migrate database"
  become: false
  become_user: www-data
  ansible.builtin.command:
    chdir: /var/www/app
    cmd: "php artisan migrate"
  register: out
  changed_when: out.rc != 0

- name: "Seed database"
  become: false
  become_user: www-data
  ansible.builtin.command:
    chdir: /var/www/app
    cmd: "php artisan db:seed"
  register: out
  changed_when: out.rc != 0
